{"title":"","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"async function getWeather(city){ let key='dc0f31ac6f37484f88e3e7d45b84e403'; //尽量换成自己申请的key以免接口失效https://console.qweather.com let locationId...","date":"2023-01-23T09:28:57.307Z","updated":"2022-06-10T08:35:11.000Z","comments":true,"path":"api/pages/88-Template/script/template/getweather.js","covers":null,"excerpt":"","content":"async function getWeather(city){\n\n\tlet key='dc0f31ac6f37484f88e3e7d45b84e403'; //尽量换成自己申请的key以免接口失效https://console.qweather.com\n\tlet locationId='';\n\tlet windydesc='';\n\tif(city)\n\t{\n\t\tlet location = await searchCity(city,key);\n\t\tlocationId =  location.id;\n\t}else\n\t{\n\t\tlet location = await getpos(key);\n\t\tlocationId =  location.id;\n\t\tcity = location.name\n\t}\n\tconsole.log('city'+city+locationId)\n\tlet weather = await getQWeather(locationId,key);\n\tconsole.log('weather'+weather)\n\tif(weather=='-1')\n\t{\n\t\treturn await getWWeather(city);\n\t}else\n\t{\n\t\t\tlet air = await getair(locationId,key);\n\t\tlet windyspeed =Math.max(weather[0].windSpeedDay,weather[0].windSpeedNight);\n\t\tif(windyspeed<12)//小风\n\t\t{\n\t\t windydesc = \"微风习习\";\n\t\t}else if(windyspeed<39)//小风\n\t\t{\n\t\t windydesc = \"清风徐徐\";\t\n\t\t}else \n\t\t\twindydesc = \"有\"+today.windDirDay+\"风出没，风力\"+today.windScaleDay+'级';\t\n\t\tlet today = weather[0];\n\t\t\tlet desc = `${city} ${today.textDay}，${today.tempMin}~${today.tempMax}℃ ${air.category} ${windydesc}${today.moonPhase.replace(/[\\u4e00-\\u9fa5]/g,\"\")}`;\n\t\t\treturn desc;\t\n\t}\n}\n\n//wttr 天气入口\nasync function getWWeather(city)\n {\n\tif(city=== undefined)\n\t{\n\t\tcity='';\n\t}\n  let result = await fetch(\"https://wttr.in/\"+city+\"?format=%l:+%c+%t+%w\").then(async (res) => await res.text());\n\tresult = result.replace(/:/g,'').replace(/\\+/g,'').replace(', China','');\n return result;\n \n }\n// 和风天气入口获取天气信息\nasync function getQWeather(locationId,key){\n\t\n\n\tdays=1;\n\tconsole.log('locationId:'+locationId);\n\tlet weatherUrl = `https://devapi.qweather.com/v7/weather/3d?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\tlet weather= data.daily.slice(0,1);\n\t\n\t//添加表情\n\tfor(let i=0;i<days;i++){\n\t\tlet textDay = weather[i].textDay;\n\t\tlet moon = weather[i].moonPhase;\n\t\tif(textDay.includes(\"雨\")){\n\t\t\tweather[i].textDay=\"🌧\"+textDay;\n\t\t}else if(textDay.includes(\"云\")){\n\t\t\tweather[i].textDay=\"⛅\"+textDay;\n\t\t}else if(textDay.includes(\"晴\")){\n\t\t\tweather[i].textDay=\"🌞\"+textDay;\n\t\t}else if(textDay.includes(\"雪\")){\n\t\t\tweather[i].textDay=\"❄\"+textDay;\n\t\t}else if(textDay.includes(\"阴\")){\n\t\t\tweather[i].textDay=\"🌥\"+textDay;\n\t\t}else if(textDay.includes(\"风\")){\n\t\t\tweather[i].textDay=\"🍃\"+textDay;\n\t\t}else if(textDay.includes(\"雷\")){\n\t\t\tweather[i].textDay=\"⛈\"+textDay;\n\t\t}else if(textDay.includes(\"雾\")){\n\t\t\tweather[i].textDay=\"🌫\"+textDay;\n\t\t}\n\t\tswitch(moon){\n\t\t\tcase \"新月\":\n\t\t\t\tweather[i].moonPhase=\"🌑\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"峨眉月\":\n\t\t\t\tweather[i].moonPhase=\"🌒\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"朔月\":\n\t\t\t\tweather[i].moonPhase=\"🌑\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"娥眉月\":\n\t\t\t\tweather[i].moonPhase=\"🌒\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"上弦月\":\n\t\t\t\tweather[i].moonPhase=\"🌓\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"盈凸月\":\n\t\t\t\tweather[i].moonPhase=\"🌔\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"满月\":\n\t\t\t\tweather[i].moonPhase=\"🌕\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"亏凸月\":\n\t\t\t\tweather[i].moonPhase=\"🌖\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"下弦月\":\n\t\t\t\tweather[i].moonPhase=\"🌗\"+moon;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tweather[i].moonPhase=\"🌘\"+moon;\n\t\t}\n\t}\n\treturn weather;\n}\n// 获取空气质量信息\nasync function getair(locationId,key){\n\n\tlet weatherUrl = `https://devapi.qweather.com/v7/air/now?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\tlet air= data.now;\n\treturn air;\n\t\n}\n\n//查询位置\nasync function urlGet(url) {\nconsole.log(url);\n  let finalURL = new URL(url);\n  const res = await request({\n    url: finalURL.href,\n    method: \"GET\",\n    cache: \"no-cache\",\n    headers: {\n      'Content-Type': 'application/json;charset=gb2312',\n\t  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.100.4758.11 Safari/537.36'\n    },\n  });\n  \n  return res;\n\n}\nasync function getpos(key) {\nlet result = await urlGet('http://whois.pconline.com.cn/ipJson.jsp?json=true')\n result = JSON.parse(result);\n\tlet city=result.cityCode;\nreturn await searchCity(city,key);\n}\n//查询城市ID\nasync function searchCity(city,key){\n\tlet searchUrl = `https://geoapi.qweather.com/v2/city/lookup?location=${city}&key=${key}&number=1`;\n\tlet sUrl = new URL(searchUrl);\n\tconst res = await request({\n\t\turl: sUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\tlet data = JSON.parse(res);\n\tif(data.code==\"200\"){\n\treturn data.location[0];\n }\n \treturn -1;\n}\n\nmodule.exports =  getWeather","count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"toc":""}