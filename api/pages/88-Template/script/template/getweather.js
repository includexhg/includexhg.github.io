{"title":"","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"async function getWeather(city){ let key='dc0f31ac6f37484f88e3e7d45b84e403'; //å°½é‡æ¢æˆè‡ªå·±ç”³è¯·çš„keyä»¥å…æ¥å£å¤±æ•ˆhttps://console.qweather.com let locationId...","date":"2023-01-23T09:28:57.307Z","updated":"2022-06-10T08:35:11.000Z","comments":true,"path":"api/pages/88-Template/script/template/getweather.js","covers":null,"excerpt":"","content":"async function getWeather(city){\n\n\tlet key='dc0f31ac6f37484f88e3e7d45b84e403'; //å°½é‡æ¢æˆè‡ªå·±ç”³è¯·çš„keyä»¥å…æ¥å£å¤±æ•ˆhttps://console.qweather.com\n\tlet locationId='';\n\tlet windydesc='';\n\tif(city)\n\t{\n\t\tlet location = await searchCity(city,key);\n\t\tlocationId =  location.id;\n\t}else\n\t{\n\t\tlet location = await getpos(key);\n\t\tlocationId =  location.id;\n\t\tcity = location.name\n\t}\n\tconsole.log('city'+city+locationId)\n\tlet weather = await getQWeather(locationId,key);\n\tconsole.log('weather'+weather)\n\tif(weather=='-1')\n\t{\n\t\treturn await getWWeather(city);\n\t}else\n\t{\n\t\t\tlet air = await getair(locationId,key);\n\t\tlet windyspeed =Math.max(weather[0].windSpeedDay,weather[0].windSpeedNight);\n\t\tif(windyspeed<12)//å°é£\n\t\t{\n\t\t windydesc = \"å¾®é£ä¹ ä¹ \";\n\t\t}else if(windyspeed<39)//å°é£\n\t\t{\n\t\t windydesc = \"æ¸…é£å¾å¾\";\t\n\t\t}else \n\t\t\twindydesc = \"æœ‰\"+today.windDirDay+\"é£å‡ºæ²¡ï¼Œé£åŠ›\"+today.windScaleDay+'çº§';\t\n\t\tlet today = weather[0];\n\t\t\tlet desc = `${city} ${today.textDay}ï¼Œ${today.tempMin}~${today.tempMax}â„ƒ ${air.category} ${windydesc}${today.moonPhase.replace(/[\\u4e00-\\u9fa5]/g,\"\")}`;\n\t\t\treturn desc;\t\n\t}\n}\n\n//wttr å¤©æ°”å…¥å£\nasync function getWWeather(city)\n {\n\tif(city=== undefined)\n\t{\n\t\tcity='';\n\t}\n  let result = await fetch(\"https://wttr.in/\"+city+\"?format=%l:+%c+%t+%w\").then(async (res) => await res.text());\n\tresult = result.replace(/:/g,'').replace(/\\+/g,'').replace(', China','');\n return result;\n \n }\n// å’Œé£å¤©æ°”å…¥å£è·å–å¤©æ°”ä¿¡æ¯\nasync function getQWeather(locationId,key){\n\t\n\n\tdays=1;\n\tconsole.log('locationId:'+locationId);\n\tlet weatherUrl = `https://devapi.qweather.com/v7/weather/3d?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\tlet weather= data.daily.slice(0,1);\n\t\n\t//æ·»åŠ è¡¨æƒ…\n\tfor(let i=0;i<days;i++){\n\t\tlet textDay = weather[i].textDay;\n\t\tlet moon = weather[i].moonPhase;\n\t\tif(textDay.includes(\"é›¨\")){\n\t\t\tweather[i].textDay=\"ğŸŒ§\"+textDay;\n\t\t}else if(textDay.includes(\"äº‘\")){\n\t\t\tweather[i].textDay=\"â›…\"+textDay;\n\t\t}else if(textDay.includes(\"æ™´\")){\n\t\t\tweather[i].textDay=\"ğŸŒ\"+textDay;\n\t\t}else if(textDay.includes(\"é›ª\")){\n\t\t\tweather[i].textDay=\"â„\"+textDay;\n\t\t}else if(textDay.includes(\"é˜´\")){\n\t\t\tweather[i].textDay=\"ğŸŒ¥\"+textDay;\n\t\t}else if(textDay.includes(\"é£\")){\n\t\t\tweather[i].textDay=\"ğŸƒ\"+textDay;\n\t\t}else if(textDay.includes(\"é›·\")){\n\t\t\tweather[i].textDay=\"â›ˆ\"+textDay;\n\t\t}else if(textDay.includes(\"é›¾\")){\n\t\t\tweather[i].textDay=\"ğŸŒ«\"+textDay;\n\t\t}\n\t\tswitch(moon){\n\t\t\tcase \"æ–°æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ‘\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"å³¨çœ‰æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ’\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"æœ”æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ‘\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"å¨¥çœ‰æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ’\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ä¸Šå¼¦æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ“\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ç›ˆå‡¸æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ”\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"æ»¡æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ•\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"äºå‡¸æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ–\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ä¸‹å¼¦æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ—\"+moon;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ˜\"+moon;\n\t\t}\n\t}\n\treturn weather;\n}\n// è·å–ç©ºæ°”è´¨é‡ä¿¡æ¯\nasync function getair(locationId,key){\n\n\tlet weatherUrl = `https://devapi.qweather.com/v7/air/now?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\tlet air= data.now;\n\treturn air;\n\t\n}\n\n//æŸ¥è¯¢ä½ç½®\nasync function urlGet(url) {\nconsole.log(url);\n  let finalURL = new URL(url);\n  const res = await request({\n    url: finalURL.href,\n    method: \"GET\",\n    cache: \"no-cache\",\n    headers: {\n      'Content-Type': 'application/json;charset=gb2312',\n\t  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.100.4758.11 Safari/537.36'\n    },\n  });\n  \n  return res;\n\n}\nasync function getpos(key) {\nlet result = await urlGet('http://whois.pconline.com.cn/ipJson.jsp?json=true')\n result = JSON.parse(result);\n\tlet city=result.cityCode;\nreturn await searchCity(city,key);\n}\n//æŸ¥è¯¢åŸå¸‚ID\nasync function searchCity(city,key){\n\tlet searchUrl = `https://geoapi.qweather.com/v2/city/lookup?location=${city}&key=${key}&number=1`;\n\tlet sUrl = new URL(searchUrl);\n\tconst res = await request({\n\t\turl: sUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\tlet data = JSON.parse(res);\n\tif(data.code==\"200\"){\n\treturn data.location[0];\n }\n \treturn -1;\n}\n\nmodule.exports =  getWeather","count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"toc":""}