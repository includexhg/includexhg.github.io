{"title":"","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"const CITY = \"City name\"; module.exports = { entry: fetchhomepage, settings: { name: \"Get Weather\", author: \"\", options: { [CITY]: { type: \"...","date":"2023-01-23T09:28:57.301Z","updated":"2022-12-26T03:23:42.950Z","comments":true,"path":"api/pages/88-Template/script/fetchhomepage.js","covers":null,"excerpt":"","content":"const CITY = \"City name\";\nmodule.exports = {\n\tentry: fetchhomepage,\n\tsettings: {\n\t  name: \"Get Weather\",\n\t  author: \"\",\n\t  options: {\n\t\t[CITY]: {\n\t\t  type: \"text\",\n\t\t  defaultValue: \"\",\n\t\t  placeholder: \"Enter the city name\",\n\t\t},\n\t  },\n\t},\n  };\n\nlet Settings;\nlet history ;\nlet today;\nasync function fetchhomepage (params,settings) {\n    ({quickAddApi} = params) \n\tSettings = settings;\n//æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n app.vault.adapter.exists(\".obsidian/.diary-stats\").then(async (exists) => {\n            if (!exists) {\n                app.vault.adapter.write(\".obsidian/.diary-stats\", \"{}\");\n            }\n\n});\nhistory = Object.assign(JSON.parse(await app.vault.adapter.read(\".obsidian/.diary-stats\")));\n//æŸ¥çœ‹å½“å¤©ä¿¡æ¯\ntoday = moment().format(\"YYYY-MM-DD\");\nawait updateToday();\n\n}\n\n//è·å–æ¯æ—¥ä¸€è¨€ä¿¡æ¯\n//è¯­å¥æ¥å£ (https://developer.hitokoto.cn/sentence/#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0)\nasync function getinfo() \n{\n      console.log(\"beigin fetch hitokoto...\");\nlet url='https://v1.hitokoto.cn/?encode=json&c=d&c=i';\n   let finalURL = new URL(url);\nlet response = await request({method: 'GET', url: finalURL.toString()});\nlet data = JSON.parse(response);\nconsole.log(data)\n\tif(data.length===0)\n\t{\n\t\treturn null;\n\t}else{\n\tlet who =data['from'];\n\t\t if(!who) who =' ';\n  const new_content = `${data['hitokoto'].trim()} <br> <em style=\"line-height: 2.8;float: right;\"> &mdash; æ¥è‡ª ${who}  ã€Š${data['from']}ã€‹</em>`; \n  return new_content;\n\t}\n}\n//æ¯æ—¥ä¸€å¥æ¥å£2\nasync function getinfo2() \n{\n      console.log(\"beigin fetch getinfo2...\");\n\tlet url='https://api.xygeng.cn/one';\n\t  let finalURL = new URL(url);\n\t  let result='';\n\t  let str='';\n    result=await  fetch(finalURL, {\n        method: 'GET',mode:'cors', cache: 'no-cache',\n\t\t\t headers: {\n            'Content-Type': 'application/json',\n        }\n    }).then(async (res) => await res.json());\n\t\n\tif(result.length===0)\n\t{\n\t\treturn null;\n\t}else\n\t{\n\t\t\n\t const origin =result['data']['origin'];\n\t let content =result['data']['content'];\n\t  content = content.trim();\n\t  str=` ${content}<br>  <em style=\"line-height: 3;float: right;\">&mdash; æ¥è‡ª ${origin} </em>`;\n\t return str;\n\t}\n}\n//åœ¨Obä¸­è·å–ç½‘æ˜“éŸ³ä¹çƒ­æ­Œæ¦œ\n//é¦–å‘äºBlue topaz Examples \n//è½¬å‘è¯·æ³¨æ˜å‡ºå¤„è°¢è°¢ï¼\nfunction getUrlQueryParams(url){\n\tconst params = {};\n\tconst keys = url.match(/([^?&]+)(?==)/g);\n\tconst values = url.match(/(?<==)([^&]*)/g);\n\tfor(const index in keys){\n\t\tparams[keys[index]] =  values[index];\n\t}\n\treturn params;\n}\n\n\n\nasync function getmusicinfo() \n{\n     console.log(\"beigin fetch getmusicinfo...\");\nlet music_id='1819970423';\nlet iframe='';\nlet url='https://api.uomg.com/api/rand.music?sort=%E7%83%AD%E6%AD%8C%E6%A6%9C&format=json';\n   let finalURL = new URL(url);\n   let result='';\n\tresult=await  fetch(finalURL, {\n\t\tmethod: 'GET'\n\t}).then(async (res) => await res.json());\n\tlet data =result['data'];\n\tlet code =result['code'];\n\tif(code==1)\n\t{\n\t   let music_url=getUrlQueryParams(data.url);\n\t\tmusic_id= music_url.id;\n\t\tiframe='<iframe id=\"music\" frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=280 height=86 src=\"https://music.163.com/outchain/player?type=2&id='+music_id+'&auto=0&height=66\"></iframe>' ;\n\t\treturn iframe;\n\t}\n}\n\nasync function get_BlueTopaz() {\n    console.log(\"beigin fetch get_BlueTopaz...\");\n    let themeday= moment().diff(moment(\"2020-10-01\"), 'days');\n    let result =  \"\\n#### ğŸ¥‘Blue Topazå·²æ›´æ–° ==\"+themeday+\"==å¤©\";\n    result = result + \"\\n##### [å¦‚æœå–œæ¬¢è¯·Starâ­](https://github.com/whyt-byte/Blue-Topaz_Obsidian-css)\";\n    return result;\n}\n\n//å†™å…¥ä¿¡æ¯\n\nasync function updateToday() {\n\n        if (!history.hasOwnProperty(moment().format(\"YYYY-MM-DD\"))) {\n\t\t\tconst quote1 = await getinfo();\n\t\t\tconst quote2 ='';\n\t\t//\tconst quote2 = await getinfo2();\n\t\t\tlet quote='';\n\t\tif(quote1!=null)\n\t\t\t{   quote=quote1;\n\t\t\t\t//let quotearr = [quote1,quote2];\n\t\t\t\t//quote = quotearr[Math.floor(Math.random()*quotearr.length)];\n\t\t\t}else\n\t\t\t{\n\t\t\t\tquote=\" å†å›°éš¾çš„äº‹æƒ…ï¼Œä½ ä¸€å»åšä¾¿ä¸å†å›°éš¾äº†ã€‚\\n Difficult thing again, you no longer difficult to do.\";\n\t\t\t}\n\t\tconst newDay = {\n            quotes: quote,\n            posters: await get_ciba(),\n           // music: await getmusicinfo(),\n            themes: await get_BlueTopaz(),\n\t\t\tweather: await getWeather(Settings[CITY]), //é»˜è®¤æ˜¯è‡ªåŠ¨è·å–ï¼Œå¦‚æœæƒ³è·å–åœ¨quicaddä¸­è®¾ç½®\n            state: 0,       \n        };\n            history[moment().format(\"YYYY-MM-DD\")] = newDay;\n\t\t\t await update();\n        }\n        today = moment().format(\"YYYY-MM-DD\");\n       \n    }\nasync function update() \n{\n app.vault.adapter.write(\".obsidian/.diary-stats\", JSON.stringify(history));\n}\n\n//åœ¨Obä¸­è·å–æ¯æ—¥è¯éœ¸\n//é¦–å‘äºBlue topaz Examples \n//è½¬å‘è¯·æ³¨æ˜å‡ºå¤„è°¢è°¢\n\nasync function get_ciba() {\n    console.log(\"beigin fetch get_ciba...\");\nlet pic='';\nlet tts='';\nlet posters='';\nlet ciba_url = new URL(\"http://open.iciba.com/dsapi/\");\t\t\nlet response = await request({method: 'GET', url: ciba_url.toString()});\nlet data = JSON.parse(response);\nif (data.sid.length == 0) {\n    await new Notice(\"No data found !\");\n} else {\n\tpic= data.fenxiang_img;\n\ttts=data.tts;\n\tposters='<div class=\"cus_pic\"><audio id=\"music\"  controls  width=\"50\" src=\" '+ tts +'\"> </audio><img src=\"'+ pic +'\" referrerpolicy=\"no-referrer\" width=\"null\" height=\"null\" alt=\"null\" style=\"box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);border-radius: 10px;\"></div>'\n\treturn posters;\n}\n}\n\n//è·å–å¤©æ°”è„šæœ¬\n// Modified by cuman  from author:@Lumos https://github.com/LumosLovegood/myScripts\n// æ•°æ®æ¥æºï¼šå’Œé£å¤©æ°”ï¼ˆhttps://www.qweather.com/ï¼‰\n\nasync function getWeather(city){\n\tconsole.log(\"beigin fetch getWeather...\"+city);\n\tlet key='dc0f31ac6f37484f88e3e7d45b84e403'; //å°½é‡æ¢æˆè‡ªå·±ç”³è¯·çš„keyä»¥å…æ¥å£å¤±æ•ˆhttps://console.qweather.com\n\tlet locationId='';\n\tlet windydesc='';\n\tif(city)\n\t{\n\t\tlet location = await searchCity(city,key);\n\t\tlocationId =  location.id;\n\t}else\n\t{\n\t\tlet location = await getpos(key);\n\t\tlocationId =  location.id;\n\t\tcity = location.name\n\t}\n\n\tlet weather = await getQWeather(locationId,key);\n\n\tif(weather=='-1')\n\t{\n\t\treturn await getWWeather(city);\n\t}else\n\t{\n\t\t//å¤©æ°”åŠ¨ç”»\n\t\t//weathericon(weather[0].iconDay,Math.max(weather[0].windSpeedDay,weather[0].windSpeedNight))\n\t\tweather[0].city=city;\n\t\tweather[0].air ='';\n\t\tlet air = await getair(locationId,key);\n\t\tif(air.code==200)\n\t\t\tweather[0].air= '=='+air.now.category+'==';\n\t\tlet windyspeed =Math.max(weather[0].windSpeedDay,weather[0].windSpeedNight);\n\t\tif(windyspeed<12)//å°é£\n\t\t{\n\t\t windydesc = \"å¾®é£ä¹ ä¹ \";\n\t\t}else if(windyspeed<39)//å°é£\n\t\t{\n\t\t windydesc = \"æ¸…é£å¾å¾\";\t\n\t\t}else \n\t\t\twindydesc = \"æœ‰\"+today.windDirDay+\"é£å‡ºæ²¡ï¼Œé£åŠ›\"+today.windScaleDay+'çº§';\t\n\n\t\tweather[0].windydesc=windydesc;\n\t\t\n\t\t\treturn weather;\t\n\t}\n}\n\n//wttr å¤©æ°”å…¥å£\nasync function getWWeather(city)\n {\n\tif(city=== undefined)\n\t{\n\t\tcity='';\n\t}\n  let result = await fetch(\"https://wttr.in/\"+city+\"?format=%l:+%c+%t+%w\").then(async (res) => await res.text());\n  if(result.includes(\"China\"))\n\tresult = result.replace(/:/g,'').replace(/\\+/g,'').replace(', China','');\n return result;\n \n }\n// å’Œé£å¤©æ°”å…¥å£è·å–å¤©æ°”ä¿¡æ¯\nasync function getQWeather(locationId,key){\n\t\n\n\tdays=1;\n\tconsole.log('locationId:'+locationId);\n\tlet weatherUrl = `https://devapi.qweather.com/v7/weather/3d?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\t let weather= data.daily;\n\t//æ·»åŠ è¡¨æƒ…\n\tfor(let i=0;i<days;i++){\n\t\tlet textDay = weather[i].textDay;\n\t\tlet moon = weather[i].moonPhase;\n\t\tif(textDay.includes(\"é›¨\")){\n\t\t\tweather[i].textDay=\"ğŸŒ§\"+textDay;\n\t\t}else if(textDay.includes(\"äº‘\")){\n\t\t\tweather[i].textDay=\"â›…\"+textDay;\n\t\t}else if(textDay.includes(\"æ™´\")){\n\t\t\tweather[i].textDay=\"ğŸŒ\"+textDay;\n\t\t}else if(textDay.includes(\"é›ª\")){\n\t\t\tweather[i].textDay=\"â„\"+textDay;\n\t\t}else if(textDay.includes(\"é˜´\")){\n\t\t\tweather[i].textDay=\"ğŸŒ¥\"+textDay;\n\t\t}else if(textDay.includes(\"é£\")){\n\t\t\tweather[i].textDay=\"ğŸƒ\"+textDay;\n\t\t}else if(textDay.includes(\"é›·\")){\n\t\t\tweather[i].textDay=\"â›ˆ\"+textDay;\n\t\t}else if(textDay.includes(\"é›¾\")){\n\t\t\tweather[i].textDay=\"ğŸŒ«\"+textDay;\n\t\t}\n\t\tswitch(moon){\n\t\t\tcase \"æ–°æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ‘\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"å³¨çœ‰æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ’\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"æœ”æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ‘\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"å¨¥çœ‰æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ’\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ä¸Šå¼¦æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ“\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ç›ˆå‡¸æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ”\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"æ»¡æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ•\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"äºå‡¸æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ–\"+moon;\n\t\t\t\tbreak;\n\t\t\tcase \"ä¸‹å¼¦æœˆ\":\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ—\"+moon;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tweather[i].moonPhase=\"ğŸŒ˜\"+moon;\n\t\t}\n\t}\n\treturn weather;\n}\n// è·å–ç©ºæ°”è´¨é‡ä¿¡æ¯\nasync function getair(locationId,key){\n\n\tlet weatherUrl = `https://devapi.qweather.com/v7/air/now?location=${locationId}&key=${key}`;\n\tlet wUrl = new URL(weatherUrl);\n \tconst res = await request({\n\t\turl: wUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\t\n\tlet data = JSON.parse(res);\n\tif(data.code!=\"200\"){\n\t \treturn -1;\n \t}\n\tlet air= data;\n\treturn air;\n\t\n}\n\n//æŸ¥è¯¢ä½ç½®\nasync function urlGet(url) {\n\n  let finalURL = new URL(url);\n  const res = await request({\n    url: finalURL.href,\n    method: \"GET\",\n    cache: \"no-cache\",\n    headers: {\n      'Content-Type': 'application/json;charset=gb2312',\n\t  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.100.4758.11 Safari/537.36'\n    },\n  });\n  \n  return res;\n\n}\nasync function getpos(key) {\nlet result = await urlGet('http://whois.pconline.com.cn/ipJson.jsp?json=true')\n result = JSON.parse(result);\n\tlet city=result.cityCode;\nreturn await searchCity(city,key);\n}\n//æŸ¥è¯¢åŸå¸‚ID\nasync function searchCity(city,key){\n\tlet searchUrl = `https://geoapi.qweather.com/v2/city/lookup?location=${city}&key=${key}&number=1`;\n\tlet sUrl = new URL(searchUrl);\n\tconst res = await request({\n\t\turl: sUrl.href,\n\t\tmethod: \"GET\",\n \t});\n\tlet data = JSON.parse(res);\n\tif(data.code==\"200\"){\n\treturn data.location[0];\n }\n \treturn -1;\n}\n\n","count_time":{"symbolsCount":"8.4k","symbolsTime":"8 mins."},"toc":""}